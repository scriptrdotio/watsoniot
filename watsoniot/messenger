var log = require("log"); log.setLevel("info");
var configModule = require("./config"); 
var clientModule = require("./client");

/**
 * @class Messenger
 * @constructor
 * @param {Object} [config] optional. Can use /config if not provided
 * @param {String} [config.username]: the app's API Key (obtained from Watson IoT service)      
 * @param {String} [config.token]: the app's auth token  (obtained from Watson IoT service) 
 * @param {String} [config.ur]: the URL prefix to use to send a command to the device (e.g. 
 * https://orgId.messaging.internetofthings.ibmcloud.com:8883/api/v0002/
 * @param {Number} [config.maxWait] 
 * @param {Object} client: optional. istance of HttpClient
 */
function Messenger(config, client) {
    
    this.config = config ? config : {username: configModule.apiKey, token: configModule.appToken, url: configModule.url, maxWait: configModule.maxWait};
    this.client = client ? client : new clientModule.HttpClient({username: this.config.username, password: this.config.token});
}

/**
 * Send a command to a device on behalf of an application
 * Expected request url: https://orgId.messaging.internetofthings.ibmcloud.com:8883/api/v0002/application/types/typeId/devices/deviceId/commands/commandId
 * @method sendCommand
 * @param {Object} [device]
 * @param {String} [device.type]: the device type
 * @param {String} [device.id]: the device id
 * @param {Object} [msg]
 * @param {Number} [msg.maxWait]:  wait time of the execution of a command
 * @param {String} [msg.params]:  arguments passed to the command (optional)
 * @param {String} [msg.commandId]:  the command to execute
 */
Messenger.prototype.sendCommand = function(device, msg) {
   
    if (!device || !device.id || !device.type) {
        
        throw {
            erroCode: "Missing_Parameter",
            errorDetail: "/watsoniot/messenger.sendCommand: device.id and device.type cannot be null or empty"
        };
    }
    
    if (!msg || !msg.type) {
        
        throw {
            erroCode: "Missing_Parameter",
            errorDetail: "/watsoniot/messenger.sendCommand: msg.type cannot be null or empty"
        };
    }
    
    var url = this.config.url + "application/types/" + device.type + "/devices/" + device.id + "/commands/" + msg.type;
    var msgBody = {
        "waitTimeSecs": msg.maxWait ? msg.maxWait : this.config.maxWait
    };
    
    if (msg.params) {
        
        for (var key in msg.params) {
            msgBody[key] = msg.params[key];
        }        
    }
    
    var reqParams = {
        
        url: url,
        method: "POST",
        headers: {          
            "Content-Type": "application/json"
        },
        params: msgBody 
    };
    
    return this.client.callApi(reqParams);
};
